#!/usr/bin/env bash
set -euo pipefail

# ========== Config ==========
IPT_V4="/etc/iptables/rules.v4"
IPT_V6="/etc/iptables/rules.v6"

# TCP ports yang dibuka
TCP_PORTS=(
  10000 10001 10002 10003 10004 10005 10006 10007 10008 10011 10012 10015
  8080 3128 1194 443 109 169 88 80 68
)

# UDP ports yang dibuka
UDP_PORTS=(53 2200 2100 5300 7100 7200 7300)

# Subnet yang di-MASQUERADE
MASQ_SUBNETS=("10.8.0.0/24" "20.8.0.0/24")

# Redirect UDP 53 (DNS) dari interface publik ke port lokal ini
DNS_REDIRECT_TO_PORT="5300"
# ============================

need_cmd() { command -v "$1" >/dev/null 2>&1 || { echo "Perintah '$1' tidak ada. Install dulu."; exit 1; }; }

need_cmd ip
need_cmd netfilter-persistent
need_cmd systemctl

# Cari interface default (yang dipakai internet)
interface="$(ip -4 route show default 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev"){print $(i+1); exit}}')"
if [[ -z "${interface:-}" ]]; then
  echo "Gagal mendeteksi interface default (ip route default)."
  exit 1
fi

# Pastikan folder ada
install -d -m 0755 /etc/iptables

# ========== Generate rules.v4 ==========
{
  echo "# Generated by custom script on $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
  echo "*filter"
  echo ":INPUT ACCEPT [0:0]"
  echo ":FORWARD ACCEPT [0:0]"
  echo ":OUTPUT ACCEPT [0:0]"

  # Allow established/related (lebih aman untuk koneksi balik)
  echo "-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT"
  echo "-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT"

  # Allow loopback
  echo "-A INPUT -i lo -j ACCEPT"

  # Open TCP ports
  for p in "${TCP_PORTS[@]}"; do
    echo "-A INPUT -p tcp --dport ${p} -j ACCEPT"
  done

  # Open UDP ports
  for p in "${UDP_PORTS[@]}"; do
    echo "-A INPUT -p udp --dport ${p} -j ACCEPT"
  done

  # Block beberapa signature torrent/malware (tetap seperti punyamu)
  echo "-A FORWARD -m string --string \"BitTorrent\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"BitTorrent protocol\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"peer_id=\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \".torrent\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"announce.php?passkey=\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"torrent\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"announce\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"info_hash\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"/default.ida?\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \".exe?/c+dir\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \".exe?/c_tftp\" --algo bm --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"peer_id\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"BitTorrent\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"BitTorrent protocol\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"bittorrent-announce\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"announce.php?passkey=\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"find_node\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"info_hash\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"get_peers\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"announce\" --algo kmp --to 65535 -j DROP"
  echo "-A FORWARD -m string --string \"announce_peers\" --algo kmp --to 65535 -j DROP"

  echo "COMMIT"
  echo ""

  echo "*nat"
  echo ":PREROUTING ACCEPT [0:0]"
  echo ":INPUT ACCEPT [0:0]"
  echo ":POSTROUTING ACCEPT [0:0]"
  echo ":OUTPUT ACCEPT [0:0]"

  # Redirect DNS UDP 53 dari interface publik ke port lokal tertentu
  echo "-A PREROUTING -i ${interface} -p udp --dport 53 -j REDIRECT --to-ports ${DNS_REDIRECT_TO_PORT}"

  # Masquerade subnet vpn
  for s in "${MASQ_SUBNETS[@]}"; do
    echo "-A POSTROUTING -s ${s} -o ${interface} -j MASQUERADE"
  done

  echo "COMMIT"
  echo ""
} > "${IPT_V4}"

# ========== Generate rules.v6 (minimal) ==========
{
  echo "# Generated by custom script on $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
  echo "*filter"
  echo ":INPUT ACCEPT [0:0]"
  echo ":FORWARD ACCEPT [0:0]"
  echo ":OUTPUT ACCEPT [0:0]"
  echo "COMMIT"
  echo ""
} > "${IPT_V6}"

# ========== Apply ==========
# Reload netfilter-persistent (cukup salah satu, tapi aman kita reload & restart)
netfilter-persistent reload || true
systemctl restart netfilter-persistent

echo "Selesai. Interface terdeteksi: ${interface}"
echo "Rules ditulis ke: ${IPT_V4} dan ${IPT_V6}"

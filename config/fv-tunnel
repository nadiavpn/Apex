#!/bin/bash
set -euo pipefail

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# System Request : Debian 11+/Ubuntu 18.04+/20+
# Developers » NadiaLestari࿐
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

REPO="https://raw.githubusercontent.com/nadiavpn/Apex/main/"

# Wajib root
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "Jalankan sebagai root."
  exit 1
fi

# Pastikan direktori ada
mkdir -p /etc/systemd/system
mkdir -p /etc/xray
mkdir -p /usr/bin

# Download service limit (xray)
wget -q -O /etc/systemd/system/limitvmess.service "${REPO}files/limitvmess.service"
chmod 644 /etc/systemd/system/limitvmess.service

wget -q -O /etc/systemd/system/limitvless.service "${REPO}files/limitvless.service"
chmod 644 /etc/systemd/system/limitvless.service

wget -q -O /etc/systemd/system/limittrojan.service "${REPO}files/limittrojan.service"
chmod 644 /etc/systemd/system/limittrojan.service

wget -q -O /etc/systemd/system/limitshadowsocks.service "${REPO}files/limitshadowsocks.service"
chmod 644 /etc/systemd/system/limitshadowsocks.service

# Download script limit xray
wget -q -O /etc/xray/limit.vmess "${REPO}files/vmess"
wget -q -O /etc/xray/limit.vless "${REPO}files/vless"
wget -q -O /etc/xray/limit.trojan "${REPO}files/trojan"
wget -q -O /etc/xray/limit.shadowsocks "${REPO}files/shadowsocks"

chmod +x /etc/xray/limit.vmess /etc/xray/limit.vless /etc/xray/limit.trojan /etc/xray/limit.shadowsocks

systemctl daemon-reload
systemctl enable --now limitvmess.service
systemctl enable --now limitvless.service
systemctl enable --now limittrojan.service
systemctl enable --now limitshadowsocks.service

# limit-ip tool
wget -q -O /usr/bin/limit-ip "${REPO}files/limit-ip"
sed -i 's/\r$//' /usr/bin/limit-ip
chmod +x /usr/bin/limit-ip

clear

# SERVICE LIMIT IP VMESS
cat >/etc/systemd/system/vmip.service <<'EOF'
[Unit]
Description=Limit IP VMESS
After=network.target

[Service]
Type=simple
WorkingDirectory=/root
ExecStart=/usr/bin/limit-ip vmip
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# SERVICE LIMIT IP VLESS
cat >/etc/systemd/system/vlip.service <<'EOF'
[Unit]
Description=Limit IP VLESS
After=network.target

[Service]
Type=simple
WorkingDirectory=/root
ExecStart=/usr/bin/limit-ip vlip
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# SERVICE LIMIT IP TROJAN
cat >/etc/systemd/system/trip.service <<'EOF'
[Unit]
Description=Limit IP TROJAN
After=network.target

[Service]
Type=simple
WorkingDirectory=/root
ExecStart=/usr/bin/limit-ip trip
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now vmip.service
systemctl enable --now vlip.service
systemctl enable --now trip.service

rm -rf /root/fv-tunnel
echo "Selesai."
